<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Export Data | FutureCast Library</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=EB+Garamond:ital,wght@0,400;0,500;0,600;0,700;1,400&family=Inter:wght@300;400;500;600&family=Noto+Sans+SC:wght@300;400;500;600&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --bg-body: #F5F5F2;
            --bg-card: #FFFFFF;
            --text-primary: #111111;
            --text-secondary: #555555;
            --text-tertiary: #888888;
            --accent-color: #8C2F39;
            --border-color: #E0E0E0;
            --shadow-card: 0 1px 3px rgba(0,0,0,0.05), 0 1px 2px rgba(0,0,0,0.1);
            --font-serif: 'EB Garamond', serif;
            --font-sans: 'Inter', sans-serif;
            --font-chinese: 'Noto Sans SC', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', sans-serif;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; outline: none; }
        
        body {
            background-color: var(--bg-body);
            color: var(--text-primary);
            font-family: var(--font-sans);
            line-height: 1.6;
            font-size: 15px;
            padding-bottom: 4rem;
        }

        header {
            max-width: 800px;
            margin: 0 auto;
            padding: 2rem 1.5rem;
        }

        .nav-back {
            display: inline-flex;
            align-items: center;
            text-decoration: none;
            color: var(--text-secondary);
            font-size: 0.9rem;
            font-weight: 500;
            margin-bottom: 2rem;
            transition: color 0.2s;
        }

        .nav-back:hover { color: var(--accent-color); }
        .nav-back svg { margin-right: 6px; width: 16px; height: 16px; }

        h1 {
            font-family: var(--font-serif);
            font-size: 2.5rem;
            font-weight: 500;
            margin-bottom: 0.5rem;
            text-align: center;
        }

        .subtitle {
            text-align: center;
            color: var(--text-secondary);
            font-family: var(--font-chinese);
            margin-bottom: 3rem;
        }

        .export-container {
            max-width: 800px;
            margin: 0 auto;
            padding: 0 1.5rem;
        }

        .export-card {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 2rem;
            box-shadow: var(--shadow-card);
            margin-bottom: 2rem;
        }

        .export-options {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .export-option {
            border: 1px solid var(--border-color);
            border-radius: 6px;
            padding: 1.5rem;
            cursor: pointer;
            transition: all 0.2s;
            background: #fff;
        }

        .export-option:hover {
            border-color: var(--accent-color);
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .export-option.selected {
            border-color: var(--accent-color);
            background: rgba(140, 47, 57, 0.05);
        }

        .option-title {
            font-weight: 600;
            margin-bottom: 0.5rem;
            font-family: var(--font-chinese);
        }

        .option-desc {
            font-size: 0.9rem;
            color: var(--text-secondary);
            font-family: var(--font-chinese);
        }

        .export-buttons {
            display: flex;
            gap: 1rem;
            justify-content: center;
            flex-wrap: wrap;
        }

        .btn {
            padding: 0.75rem 2rem;
            border: none;
            border-radius: 6px;
            font-size: 0.9rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            font-family: var(--font-sans);
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }

        .btn-primary {
            background-color: var(--accent-color);
            color: white;
        }

        .btn-primary:hover {
            background-color: #7A2832;
            transform: translateY(-1px);
        }

        .btn-secondary {
            background-color: #f5f5f5;
            color: var(--text-primary);
            border: 1px solid var(--border-color);
        }

        .btn-secondary:hover {
            background-color: #e5e5e5;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .stat-item {
            text-align: center;
            padding: 1rem;
            background: #f9f9f9;
            border-radius: 6px;
        }

        .stat-number {
            font-size: 2rem;
            font-weight: 600;
            color: var(--accent-color);
            font-family: var(--font-serif);
        }

        .stat-label {
            font-size: 0.8rem;
            color: var(--text-secondary);
            font-family: var(--font-chinese);
        }

        .preview-section {
            margin-top: 2rem;
            padding-top: 2rem;
            border-top: 1px solid var(--border-color);
        }

        .preview-content {
            background: #f9f9f9;
            border-radius: 6px;
            padding: 1rem;
            font-family: monospace;
            font-size: 0.8rem;
            max-height: 300px;
            overflow-y: auto;
            white-space: pre-wrap;
        }

        @media (max-width: 600px) {
            .export-buttons { flex-direction: column; }
            .btn { justify-content: center; }
        }
    </style>
</head>
<body>
    <header>
        <a href="Bookcast.html" class="nav-back">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="19" y1="12" x2="5" y2="12"></line><polyline points="12 19 5 12 12 5"></polyline></svg>
            Back to Library
        </a>
        
        <h1>Export Data</h1>
        <div class="subtitle">Export your reading progress and notes</div>
    </header>

    <main class="export-container">
        <!-- ÁªüËÆ°‰ø°ÊÅØ -->
        <div class="export-card">
            <div class="stats-grid" id="statsGrid">
                <!-- ÁªüËÆ°Êï∞ÊçÆÂ∞ÜÂú®ËøôÈáåÊòæÁ§∫ -->
            </div>
        </div>

        <!-- ÂØºÂá∫ÈÄâÈ°π -->
        <div class="export-card">
            <h3 style="margin-bottom: 1.5rem; font-family: var(--font-sans);">Choose Export Format</h3>
            
            <div class="export-options">
                <div class="export-option selected" data-format="json">
                    <div class="option-title">JSON Format</div>
                    <div class="option-desc">Structured data, ideal for backup and restoration</div>
                </div>
                
                <div class="export-option" data-format="markdown">
                    <div class="option-title">Markdown Format</div>
                    <div class="option-desc">Human-readable text format, perfect for viewing and sharing</div>
                </div>
                
                <div class="export-option" data-format="csv">
                    <div class="option-title">CSV Format</div>
                    <div class="option-desc">Tabular data, can be imported into Excel for analysis</div>
                </div>
            </div>

            <div class="export-buttons">
                <button class="btn btn-primary" onclick="exportData()">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                        <polyline points="7 10 12 15 17 10"></polyline>
                        <line x1="12" y1="15" x2="12" y2="3"></line>
                    </svg>
                    Export Data
                </button>
                
                <button class="btn btn-secondary" onclick="previewData()">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
                        <circle cx="12" cy="12" r="3"></circle>
                    </svg>
                    Preview Data
                </button>
                
                <a href="import-data.html" class="btn btn-secondary">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                        <polyline points="17 8 12 3 7 8"></polyline>
                        <line x1="12" y1="3" x2="12" y2="15"></line>
                    </svg>
                    Import Data
                </a>
            </div>
        </div>

        <!-- È¢ÑËßàÂå∫Âüü -->
        <div class="export-card preview-section" id="previewSection" style="display: none;">
            <h3 style="margin-bottom: 1rem; font-family: var(--font-sans);">Data Preview</h3>
            <div class="preview-content" id="previewContent"></div>
        </div>
    </main>

    <script>
        // ‰π¶Á±çÊï∞ÊçÆ (‰∏éÂÖ∂‰ªñÈ°µÈù¢‰øùÊåÅ‰∏ÄËá¥)
        const booksData = [
            { rank: 1, en: "Sapiens", cn: "‰∫∫Á±ªÁÆÄÂè≤", author: "Yuval Noah Harari" },
            { rank: 2, en: "Man's Search for Meaning", cn: "Ê¥ªÂá∫ÊÑè‰πâÊù•", author: "Viktor E. Frankl" },
            { rank: 3, en: "Principles", cn: "ÂéüÂàô", author: "Ray Dalio" },
            { rank: 4, en: "Zero to One", cn: "‰ªé0Âà∞1", author: "Peter Thiel" },
            { rank: 5, en: "Thinking, Fast and Slow", cn: "ÊÄùËÄÉÔºåÂø´‰∏éÊÖ¢", author: "Daniel Kahneman" },
            { rank: 6, en: "Influence", cn: "ÂΩ±ÂìçÂäõ", author: "Robert B. Cialdini" },
            { rank: 7, en: "The 4-Hour Workweek", cn: "ÊØèÂë®Â∑•‰Ωú4Â∞èÊó∂", author: "Tim Ferriss" },
            { rank: 8, en: "The Hard Thing About Hard Things", cn: "Âàõ‰∏öÁª¥Ëâ∞", author: "Ben Horowitz" },
            { rank: 9, en: "Shoe Dog", cn: "ÈûãÁãó", author: "Phil Knight" },
            { rank: 10, en: "Atlas Shrugged", cn: "ÈòøÁâπÊãâÊñØËÄ∏ËÄ∏ËÇ©", author: "Ayn Rand" },
            { rank: 11, en: "The Innovator's Dilemma", cn: "ÂàõÊñ∞ËÄÖÁöÑÁ™òÂ¢É", author: "Clayton M. Christensen" },
            { rank: 12, en: "Atomic Habits", cn: "ÂéüÂ≠ê‰π†ÊÉØ", author: "James Clear" },
            { rank: 13, en: "The Alchemist", cn: "ÁâßÁæäÂ∞ëÂπ¥Â•áÂπª‰πãÊóÖ", author: "Paulo Coelho" },
            { rank: 14, en: "Meditations", cn: "Ê≤âÊÄùÂΩï", author: "Marcus Aurelius" },
            { rank: 15, en: "The War of Art", cn: "Ëâ∫ÊúØÊàò‰∫â", author: "Steven Pressfield" },
            { rank: 16, en: "High Output Management", cn: "Ê†ºÈ≤ÅÂ§´ÁªôÁªèÁêÜ‰∫∫ÁöÑÁ¨¨‰∏ÄËØæ", author: "Andrew Grove" },
            { rank: 17, en: "Antifragile", cn: "ÂèçËÑÜÂº±", author: "Nassim Nicholas Taleb" },
            { rank: 18, en: "Steve Jobs", cn: "Âè≤ËíÇÂ§´¬∑‰πîÂ∏ÉÊñØ‰º†", author: "Walter Isaacson" },
            { rank: 19, en: "How To Win Friends and Influence People", cn: "‰∫∫ÊÄßÁöÑÂº±ÁÇπ", author: "Dale Carnegie" },
            { rank: 20, en: "Dune", cn: "Ê≤ô‰∏ò", author: "Frank Herbert" },
            { rank: 21, en: "Good to Great", cn: "‰ªé‰ºòÁßÄÂà∞ÂçìË∂ä", author: "Jim Collins" },
            { rank: 22, en: "Mindset", cn: "ÁªàË∫´ÊàêÈïø", author: "Carol S. Dweck" },
            { rank: 23, en: "Harry Potter", cn: "ÂìàÂà©¬∑Ê≥¢Áâπ", author: "J.K. Rowling" },
            { rank: 24, en: "The Black Swan", cn: "ÈªëÂ§©ÈπÖ", author: "Nassim Nicholas Taleb" },
            { rank: 25, en: "Surely You're Joking, Mr. Feynman!", cn: "Âà´Èóπ‰∫ÜÔºåË¥πÊõºÂÖàÁîü", author: "Richard P. Feynman" },
            { rank: 26, en: "1984", cn: "1984", author: "George Orwell" },
            { rank: 27, en: "Outliers", cn: "ÂºÇÁ±ª", author: "Malcolm Gladwell" },
            { rank: 28, en: "The Lean Startup", cn: "Á≤æÁõäÂàõ‰∏ö", author: "Eric Ries" },
            { rank: 29, en: "Poor Charlie's Almanack", cn: "Á©∑Êü•ÁêÜÂÆùÂÖ∏", author: "Charlie Munger" },
            { rank: 30, en: "Snow Crash", cn: "Èõ™Â¥©", author: "Neal Stephenson" },
            { rank: 31, en: "Range", cn: "Ë∑®ËÉΩËá¥Âãù (ÈÄöÊâç)", author: "David Epstein" },
            { rank: 32, en: "The Four Agreements", cn: "ÈÄöÂæÄÂøÉÁÅµËá™Áî±ÁöÑÂõõ‰∏™Á∫¶ÂÆö", author: "Don Miguel Ruiz" },
            { rank: 33, en: "Elon Musk", cn: "Á°ÖË∞∑Èí¢ÈìÅ‰æ†", author: "Ashlee Vance" },
            { rank: 34, en: "Siddhartha", cn: "ÊÇâËææÂ§ö", author: "Hermann Hesse" },
            { rank: 35, en: "Skin in the Game", cn: "ÈùûÂØπÁß∞È£éÈô©", author: "Nassim Nicholas Taleb" },
            { rank: 36, en: "Tools of Titans", cn: "Â∑®‰∫∫ÁöÑÂ∑•ÂÖ∑", author: "Tim Ferriss" },
            { rank: 37, en: "The Selfish Gene", cn: "Ëá™ÁßÅÁöÑÂü∫Âõ†", author: "Richard Dawkins" },
            { rank: 38, en: "The Intelligent Investor", cn: "ËÅ™ÊòéÁöÑÊäïËµÑËÄÖ", author: "Benjamin Graham" },
            { rank: 39, en: "Essentialism", cn: "Á≤æË¶Å‰∏ª‰πâ", author: "Greg McKeown" },
            { rank: 40, en: "The Lord of the Rings", cn: "ÊåáÁéØÁéã", author: "J.R.R. Tolkien" },
            { rank: 41, en: "The Ride of a Lifetime", cn: "‰∏ÄÁîüÁöÑÊóÖÁ®ã", author: "Robert Iger" },
            { rank: 42, en: "The Lessons of History", cn: "ÂéÜÂè≤ÁöÑÊïôËÆ≠", author: "Will & Ariel Durant" },
            { rank: 43, en: "Loonshots", cn: "Áõ∏Âèò", author: "Safi Bahcall" },
            { rank: 44, en: "The Fountainhead", cn: "Ê∫êÊ≥â", author: "Ayn Rand" },
            { rank: 45, en: "The Three-Body Problem", cn: "‰∏â‰Ωì", author: "Cixin Liu" },
            { rank: 46, en: "How to Change Your Mind", cn: "ÊîπËÆä‰Ω†ÁöÑÂøÉÊô∫", author: "Michael Pollan" },
            { rank: 47, en: "Tao Te Ching", cn: "ÈÅìÂæ∑Áªè", author: "Lao Tzu" },
            { rank: 48, en: "12 Rules for Life", cn: "‰∫∫ÁîüÂçÅ‰∫åÊ≥ïÂàô", author: "Jordan Peterson" },
            { rank: 49, en: "Crime and Punishment", cn: "ÁΩ™‰∏éÁΩö", author: "Fyodor Dostoyevsky" },
            { rank: 50, en: "When Breath Becomes Air", cn: "ÂΩìÂëºÂê∏Âåñ‰∏∫Á©∫Ê∞î", author: "Paul Kalanithi" },
            { rank: 51, en: "The Great Gatsby", cn: "‰∫Ü‰∏çËµ∑ÁöÑÁõñËå®ÊØî", author: "F. Scott Fitzgerald" },
            { rank: 52, en: "Guns, Germs, and Steel", cn: "Êû™ÁÇÆ„ÄÅÁóÖËèå‰∏éÈí¢ÈìÅ", author: "Jared Diamond" },
            { rank: 53, en: "The Power of Habit", cn: "‰π†ÊÉØÁöÑÂäõÈáè", author: "Charles Duhigg" },
            { rank: 54, en: "The Catcher in the Rye", cn: "È∫¶Áî∞ÈáåÁöÑÂÆàÊúõËÄÖ", author: "J.D. Salinger" },
            { rank: 55, en: "The Design of Everyday Things", cn: "ËÆæËÆ°ÂøÉÁêÜÂ≠¶", author: "Don Norman" },
            { rank: 56, en: "Creativity, Inc.", cn: "ÂàõÊñ∞ÂÖ¨Âè∏", author: "Ed Catmull" },
            { rank: 57, en: "The 7 Habits of Highly Effective People", cn: "È´òÊïàËÉΩ‰∫∫Â£´ÁöÑ‰∏É‰∏™‰π†ÊÉØ", author: "Stephen R. Covey" },
            { rank: 58, en: "Deep Work", cn: "Ê∑±Â∫¶Â∑•‰Ωú", author: "Cal Newport" },
            { rank: 59, en: "The Art of War", cn: "Â≠ôÂ≠êÂÖµÊ≥ï", author: "Sun Tzu" },
            { rank: 60, en: "Fooled by Randomness", cn: "ÈöèÊú∫Êº´Ê≠•ÁöÑÂÇªÁìú", author: "Nassim Nicholas Taleb" },
            { rank: 61, en: "The Checklist Manifesto", cn: "Ê∏ÖÂçïÈù©ÂëΩ", author: "Atul Gawande" },
            { rank: 62, en: "The Courage to Be Disliked", cn: "Ë¢´ËÆ®ÂéåÁöÑÂãáÊ∞î", author: "Ichiro Kishimi" },
            { rank: 63, en: "Brave New World", cn: "Áæé‰∏ΩÊñ∞‰∏ñÁïå", author: "Aldous Huxley" },
            { rank: 64, en: "Homo Deus", cn: "Êú™Êù•ÁÆÄÂè≤", author: "Yuval Noah Harari" },
            { rank: 65, en: "Zen and the Art of Motorcycle Maintenance", cn: "Á¶Ö‰∏éÊë©ÊâòËΩ¶Áª¥‰øÆËâ∫ÊúØ", author: "Robert M. Pirsig" },
            { rank: 66, en: "The Score Takes Care of Itself", cn: "Á°¨Ê¥æÈ¢ÜÂØºÂì≤Â≠¶", author: "Bill Walsh" },
            { rank: 67, en: "Crossing the Chasm", cn: "Ë∑®Ë∂äÈ∏øÊ≤ü", author: "Geoffrey A. Moore" },
            { rank: 68, en: "Extreme Ownership", cn: "ÊûÅÁ´ØÊâÄÊúâÊùÉ", author: "Jocko Willink" },
            { rank: 69, en: "High Growth Handbook", cn: "È´òÊàêÈïøÊâãÂÜå", author: "Elad Gil" },
            { rank: 70, en: "Project Hail Mary", cn: "ÊåΩÊïëËÆ°Âàí", author: "Andy Weir" },
            { rank: 71, en: "Made to Stick", cn: "Á≤ò‰Ωè", author: "Chip & Dan Heath" },
            { rank: 72, en: "The Effective Executive", cn: "ÂçìÊúâÊàêÊïàÁöÑÁÆ°ÁêÜËÄÖ", author: "Peter F. Drucker" },
            { rank: 73, en: "The Undoing Project", cn: "Ê©°ÁöÆÊì¶ËÆ°Âàí", author: "Michael Lewis" },
            { rank: 74, en: "Why We Sleep", cn: "‰∏∫‰ªÄ‰πàË¶ÅÁù°Ëßâ", author: "Matthew Walker" },
            { rank: 75, en: "Anna Karenina", cn: "ÂÆâÂ®ú¬∑Âç°ÂàóÂ∞ºÂ®ú", author: "Leo Tolstoy" },
            { rank: 76, en: "Benjamin Franklin", cn: "ÂØåÂÖ∞ÂÖãÊûó‰º†", author: "Walter Isaacson" },
            { rank: 77, en: "Animal Farm", cn: "Âä®Áâ©Â∫ÑÂõ≠", author: "George Orwell" },
            { rank: 78, en: "The Almanack of Naval Ravikant", cn: "Á∫≥Áì¶Â∞îÂÆùÂÖ∏", author: "Eric Jorgenson" },
            { rank: 79, en: "The Psychology of Money", cn: "ÈáëÈí±ÂøÉÁêÜÂ≠¶", author: "Morgan Housel" },
            { rank: 80, en: "Measure What Matters", cn: "Ë°°Èáè‰ªÄ‰πàÈáçË¶Å", author: "John Doerr" },
            { rank: 81, en: "Think and Grow Rich", cn: "ÊÄùËÄÉËá¥ÂØå", author: "Napoleon Hill" },
            { rank: 82, en: "Only the Paranoid Survive", cn: "Âè™ÊúâÂÅèÊâßÁãÇÊâçËÉΩÁîüÂ≠ò", author: "Andrew Grove" },
            { rank: 83, en: "Can't Hurt Me", cn: "ÊàëÔºåÂàÄÊû™‰∏çÂÖ•", author: "David Goggins" },
            { rank: 84, en: "Foundation", cn: "Âü∫Âú∞", author: "Isaac Asimov" },
            { rank: 85, en: "Blitzscaling", cn: "Èó™ÁîµÂºèÊâ©Âº†", author: "Reid Hoffman" },
            { rank: 86, en: "Seeking Wisdom", cn: "Êé¢Á¥¢Êô∫ÊÖß", author: "Peter Bevelin" },
            { rank: 87, en: "Digital Minimalism", cn: "Êï∞Â≠óÊûÅÁÆÄ‰∏ª‰πâ", author: "Cal Newport" },
            { rank: 88, en: "How Not to Die", cn: "ÊïëÂëΩ", author: "Dr. Michael Greger" },
            { rank: 89, en: "The Art of Possibility", cn: "ÂèØËÉΩÊÄßËâ∫ÊúØ", author: "Rosamund Stone Zander" },
            { rank: 90, en: "The Righteous Mind", cn: "Ê≠£‰πâ‰πãÂøÉ", author: "Jonathan Haidt" },
            { rank: 91, en: "The Book of Five Rings", cn: "‰∫îËΩÆ‰π¶", author: "Miyamoto Musashi" },
            { rank: 92, en: "The Code Breaker", cn: "Á†¥Ëß£ËÄÖ", author: "Walter Isaacson" },
            { rank: 93, en: "The Emperor of All Maladies", cn: "‰∏áÁóÖ‰πãÁéã", author: "Siddhartha Mukherjee" },
            { rank: 94, en: "The Gene", cn: "Âü∫Âõ†", author: "Siddhartha Mukherjee" },
            { rank: 95, en: "The Innovators", cn: "ÂàõÊñ∞ËÄÖ", author: "Walter Isaacson" },
            { rank: 96, en: "The Everything Store", cn: "‰∏ÄÁΩëÊâìÂ∞Ω", author: "Brad Stone" },
            { rank: 97, en: "The Wright Brothers", cn: "Ëé±ÁâπÂÖÑÂºü", author: "David McCullough" },
            { rank: 98, en: "The Making of the Atomic Bomb", cn: "ÂéüÂ≠êÂºπÁßòÂè≤", author: "Richard Rhodes" },
            { rank: 99, en: "The Structure of Scientific Revolutions", cn: "ÁßëÂ≠¶Èù©ÂëΩÁöÑÁªìÊûÑ", author: "Thomas S. Kuhn" },
            { rank: 100, en: "Thinking in Systems", cn: "Á≥ªÁªü‰πãÁæé", author: "Donella Meadows" }
        ];

        let selectedFormat = 'json';
        let db;
        const DB_NAME = 'BookcastDB';
        const STORE_NAME = 'notes';

        function initDB() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open(DB_NAME, 1);
                
                request.onerror = () => reject(request.error);
                request.onsuccess = () => {
                    db = request.result;
                    resolve(db);
                };
                
                request.onupgradeneeded = (event) => {
                    const database = event.target.result;
                    if (!database.objectStoreNames.contains(STORE_NAME)) {
                        database.createObjectStore(STORE_NAME, { keyPath: 'bookId' });
                    }
                };
            });
        }

        function getNotesFromDB(bookId) {
            return new Promise((resolve) => {
                if (!db) {
                    resolve([]);
                    return;
                }
                
                const transaction = db.transaction([STORE_NAME], 'readonly');
                const store = transaction.objectStore(STORE_NAME);
                const request = store.get(bookId);
                
                request.onsuccess = () => {
                    const result = request.result;
                    resolve(result ? result.notes : []);
                };
                
                request.onerror = () => {
                    resolve([]);
                };
            });
        }

        async function init() {
            try {
                await initDB();
                console.log('Database initialized');
            } catch (error) {
                console.warn('Failed to initialize IndexedDB:', error);
            }
            
            await updateStats();
            setupEventListeners();
        }

        function setupEventListeners() {
            // Ê†ºÂºèÈÄâÊã©
            document.querySelectorAll('.export-option').forEach(option => {
                option.addEventListener('click', () => {
                    document.querySelectorAll('.export-option').forEach(o => o.classList.remove('selected'));
                    option.classList.add('selected');
                    selectedFormat = option.dataset.format;
                });
            });
        }

        async function updateStats() {
            const readState = JSON.parse(localStorage.getItem('bookReadState')) || {};
            const readCount = Object.values(readState).filter(Boolean).length;
            
            // ÁªüËÆ°Á¨îËÆ∞Êï∞Èáè
            let totalNotes = 0;
            let booksWithNotes = 0;
            
            for (const book of booksData) {
                // Try IndexedDB first, then fall back to localStorage
                let notes = await getNotesFromDB(book.rank);
                if (notes.length === 0) {
                    notes = JSON.parse(localStorage.getItem(`book_notes_${book.rank}`)) || [];
                }
                
                if (notes.length > 0) {
                    booksWithNotes++;
                    totalNotes += notes.length;
                }
            }

            const statsGrid = document.getElementById('statsGrid');
            statsGrid.innerHTML = `
                <div class="stat-item">
                    <div class="stat-number">${readCount}</div>
                    <div class="stat-label">Books Read</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number">${100 - readCount}</div>
                    <div class="stat-label">Books Unread</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number">${booksWithNotes}</div>
                    <div class="stat-label">Books with Notes</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number">${totalNotes}</div>
                    <div class="stat-label">Total Notes</div>
                </div>
            `;
        }

        async function collectAllData() {
            const readState = JSON.parse(localStorage.getItem('bookReadState')) || {};
            const exportData = {
                exportDate: new Date().toISOString(),
                totalBooks: booksData.length,
                readCount: Object.values(readState).filter(Boolean).length,
                books: []
            };

            for (const book of booksData) {
                // Try IndexedDB first, then fall back to localStorage
                let notes = await getNotesFromDB(book.rank);
                if (notes.length === 0) {
                    notes = JSON.parse(localStorage.getItem(`book_notes_${book.rank}`)) || [];
                }
                
                const bookData = {
                    rank: book.rank,
                    title: {
                        en: book.en,
                        cn: book.cn
                    },
                    author: book.author,
                    isRead: !!readState[book.rank],
                    notes: notes.map(note => ({
                        id: note.id,
                        text: note.text || note.html || '',
                        html: note.html,
                        timestamp: note.timestamp,
                        date: new Date(note.timestamp).toLocaleString('zh-CN')
                    }))
                };
                exportData.books.push(bookData);
            }

            return exportData;
        }

        function formatAsJSON(data) {
            return JSON.stringify(data, null, 2);
        }

        function formatAsMarkdown(data) {
            let md = `# FutureCast Library Reading Record\n\n`;
            md += `**Export Date**: ${new Date(data.exportDate).toLocaleString('en-US')}\n`;
            md += `**Total Books**: ${data.totalBooks}\n`;
            md += `**Books Read**: ${data.readCount}\n`;
            md += `**Reading Progress**: ${((data.readCount / data.totalBooks) * 100).toFixed(1)}%\n\n`;

            // Read books
            const readBooks = data.books.filter(book => book.isRead);
            if (readBooks.length > 0) {
                md += `## üìö Books Read (${readBooks.length} books)\n\n`;
                readBooks.forEach(book => {
                    md += `### ${book.rank}. ${book.title.en}\n`;
                    md += `**Chinese Title**: ${book.title.cn}\n`;
                    md += `**Author**: ${book.author}\n`;
                    
                    if (book.notes.length > 0) {
                        md += `**Notes Count**: ${book.notes.length}\n\n`;
                        book.notes.forEach((note, index) => {
                            md += `#### Note ${index + 1} (${note.date})\n`;
                            md += `${note.text}\n\n`;
                        });
                    } else {
                        md += `**Notes**: None\n\n`;
                    }
                    md += `---\n\n`;
                });
            }

            // Unread books
            const unreadBooks = data.books.filter(book => !book.isRead);
            if (unreadBooks.length > 0) {
                md += `## üìñ Books to Read (${unreadBooks.length} books)\n\n`;
                unreadBooks.forEach(book => {
                    md += `- ${book.rank}. **${book.title.en}** (${book.title.cn}) - ${book.author}\n`;
                });
            }

            return md;
        }

        function formatAsCSV(data) {
            let csv = 'Rank,Title_EN,Title_CN,Author,IsRead,NotesCount,LatestNote\n';
            
            data.books.forEach(book => {
                const latestNote = book.notes.length > 0 ? 
                    book.notes[0].text.replace(/"/g, '""').replace(/\n/g, ' ') : '';
                
                csv += `${book.rank},"${book.title.en}","${book.title.cn}","${book.author}",${book.isRead ? 'Yes' : 'No'},${book.notes.length},"${latestNote}"\n`;
            });
            
            return csv;
        }

        async function previewData() {
            const data = await collectAllData();
            let formattedData = '';
            
            switch (selectedFormat) {
                case 'json':
                    formattedData = formatAsJSON(data);
                    break;
                case 'markdown':
                    formattedData = formatAsMarkdown(data);
                    break;
                case 'csv':
                    formattedData = formatAsCSV(data);
                    break;
            }
            
            document.getElementById('previewContent').textContent = formattedData;
            document.getElementById('previewSection').style.display = 'block';
            document.getElementById('previewSection').scrollIntoView({ behavior: 'smooth' });
        }

        async function exportData() {
            const data = await collectAllData();
            let content = '';
            let filename = '';
            let mimeType = '';
            
            switch (selectedFormat) {
                case 'json':
                    content = formatAsJSON(data);
                    filename = `futurecast-library-${new Date().toISOString().split('T')[0]}.json`;
                    mimeType = 'application/json';
                    break;
                case 'markdown':
                    content = formatAsMarkdown(data);
                    filename = `futurecast-library-${new Date().toISOString().split('T')[0]}.md`;
                    mimeType = 'text/markdown';
                    break;
                case 'csv':
                    content = formatAsCSV(data);
                    filename = `futurecast-library-${new Date().toISOString().split('T')[0]}.csv`;
                    mimeType = 'text/csv';
                    break;
            }
            
            // ÂàõÂª∫‰∏ãËΩΩÈìæÊé•
            const blob = new Blob([content], { type: mimeType });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            // ÊòæÁ§∫ÊàêÂäüÊ∂àÊÅØ
            alert(`Data successfully exported as ${filename}`);
        }

        // ÂàùÂßãÂåñ
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>